#!/bin/sh
#######################################################################
#  $RCSfile$
#
#  Copyright (C) 2004 Novell, Inc.
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of the GNU General Public
#  License as published by the Free Software Foundation; either
#  version 2 of the License, or (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
#  General Public License for more details.
#
#  You should have received a copy of the GNU General Public
#  License along with this program; if not, write to the Free
#  Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
#
#  Author: Paul Thomas <pthomas@novell.com>
#
#######################################################################

#======================================================================
# Configure the client to startup each time the user logs in, or remove
# such configuration.
#
# NOTE: always exit 0 to avoid problems when running within RPM.
#======================================================================
NAME=setup-autostart

# Display usage statement and exit
usage()
{
    echo $NAME
    cat <<- HERE >&2
usage: $NAME [OPTION] <home_path>
  OPTION:
  -e            erase configuration
  -v            verbose output
  -h, --help    display this help, then exit
  
  <home_path>   full path to a user's home directory (e.g., /home/<user>)
HERE
}

# If VERBOSE mode, echo message
echo_v()
{
    if test -n "$VERBOSE"; then
        echo $*
    fi
}

# Output an error message
error_v()
{
    if test -n "$VERBOSE"; then
        echo $* >&2
    fi
}

# If VERBOSE mode, display variable=value before
# setting variable $1 to value $2
setvar_v()
{
    echo_v $1=$2
    eval $1=\"$2\"
    if ! test "$?" = "0"; then exit 0; fi
}

echo_v "0=$0, 1=$1, *=$*"

# Check for help option
if test "$1" = "-h" -o "$1" = "--help"
then
    usage
    exit 0
fi

# Check for erase option
if test "$1" = "-e"
then
    ERASE=1
    shift
fi

# Check for verbose mode
if test "$1" = "-v"
then
    VERBOSE=1
    shift
fi

#
# Verify that required argument was passed in
#
ARGCNT=1
if test $# -ne $ARGCNT
then
    error_v "invalid argument count: expected=$ARGCNT, actual=$#"
    usage
    exit 0
fi

# Variables for configuring startup
setvar_v GNOME_HOME $1/.gnome2
setvar_v GNOME_USER `basename $1`
setvar_v STARTUP_FILE $GNOME_HOME/session-manual
setvar_v TEMP_STARTUP_FILE $GNOME_HOME/session-manual.tmp
setvar_v SED_FILE $GNOME_HOME/session-manual.sed
setvar_v RESTART_STYLE_HINT 3
setvar_v PRIORITY 50
setvar_v RESTART_COMMAND "@prefix@/bin/ifolder"

echo_v "ERASE = $ERASE"
if test -n "$ERASE"
then
    #
    # Erase the configuration
    #
    # If GNOME desktop is not installed, exit
    if ! test -d $GNOME_HOME
    then
        error_v $GNOME_HOME directory does not exist, cannot unconfigure startup
        exit 0
    fi
    
    # If $STARTUP_FILE does not exist, exit
    if ! test -f "$STARTUP_FILE"
    then
        error_v "$STARTUP_FILE does not exist, cannot unconfigure startup"
        exit 0
    fi
    
    # if $STARTUP_FILE does not contain RESTART_COMMAND, exit
    if ! grep -q "$RESTART_COMMAND" "$STARTUP_FILE" 2>/dev/null 
    then
        echo_v "$STARTUP_FILE does not contain $RESTART_COMMAND"
        exit 0
    fi    
    
    # $STARTUP_FILE contains RESTART_COMMAND, so remove it
    setvar_v NUMCLIENTS `grep num_clients "$STARTUP_FILE" | sed "s/num_clients=\([0-9]*\)/\1/"`
    setvar_v NUMCLIENTS `expr $NUMCLIENTS - 1`
    if test "$NUMCLIENTS" = 0
    then
        # Removing only entry so remove file instead.
        echo_v "removing $STARTUP_FILE (only entry is $RESTART_COMMAND)"
        rm -f "$STARTUP_FILE"
    else
        # Remove client from $STARTUP_FILE
        setvar_v index `grep "RestartCommand=$RESTART_COMMAND" "$STARTUP_FILE" | sed "s;\([0-9]*\),RestartCommand=$RESTART_COMMAND;\1;"`
        
        echo "s/\(.*num_clients=\).*/\1$NUMCLIENTS/" > $SED_FILE
        echo "/$index,/d" >> $SED_FILE
        
        setvar_v index `expr $index + 1`
        while expr $index \< \( $NUMCLIENTS + 2 \) > /dev/null
        do
            setvar_v new_index `expr $index - 1`
            echo_v "index $index ==> $new_index"
            echo "s;$index,;$new_index,;" >> $SED_FILE
            setvar_v index `expr $index + 1`
        done
        
        if test -n "$VERBOSE"; then
            echo =======================================
            echo $SED_FILE
            echo =======================================
            cat $SED_FILE
            echo =======================================
        fi
        
        sed -f "$SED_FILE" "$STARTUP_FILE" > "$TEMP_STARTUP_FILE"
        rm -f $SED_FILE
        
        if test -n "$VERBOSE"; then
            echo =======================================
            echo diff $STARTUP_FILE $TEMP_STARTUP_FILE
            echo =======================================
            diff "$STARTUP_FILE" "$TEMP_STARTUP_FILE"
            echo =======================================
        fi
        
        # Move new startup file into place
        mv "$TEMP_STARTUP_FILE" "$STARTUP_FILE"
        chown "$GNOME_USER" "$STARTUP_FILE"
        chgrp users "$STARTUP_FILE"
    fi
else
    #
    # Configure tray app to start up on user login
    #
    # If GNOME desktop is not installed, exit
    if ! test -d $GNOME_HOME
    then
        error_v $GNOME_HOME directory does not exist, cannot configure startup
        exit 0
    fi
    
    # if $STARTUP_FILE already contains RESTART_COMMAND, exit
    if grep -q "$RESTART_COMMAND" "$STARTUP_FILE" 2>/dev/null 
    then
        echo_v "$STARTUP_FILE already contains $RESTART_COMMAND"
        exit 0
    fi    
    
    if ! test -f "$STARTUP_FILE"
    then
        # $STARTUP_FILE does not exist, so create one with one client
        setvar_v NUMCLIENTS 1
        cat <<- HERE > "$TEMP_STARTUP_FILE"
[Default]
num_clients=$NUMCLIENTS
HERE
        chmod 644 "$TEMP_STARTUP_FILE"
    else
        # $STARTUP_FILE exists, so add one client
        setvar_v NUMCLIENTS `grep num_clients "$STARTUP_FILE" | sed "s/num_clients=\([0-9]*\)/\1/"`
        setvar_v NUMCLIENTS `expr $NUMCLIENTS + 1`
        sed "s/\(.*num_clients=\).*/\1$NUMCLIENTS/" "$STARTUP_FILE" > "$TEMP_STARTUP_FILE"
    fi
    
    # Append the new entry at the end of the startup file
    setvar_v CLIENT_INDEX `expr $NUMCLIENTS - 1`
    cat <<- HERE >> "$TEMP_STARTUP_FILE"
$CLIENT_INDEX,RestartStyleHint=$RESTART_STYLE_HINT
$CLIENT_INDEX,Priority=$PRIORITY
$CLIENT_INDEX,RestartCommand=$RESTART_COMMAND
HERE
    # Move new startup file into place
    mv "$TEMP_STARTUP_FILE" "$STARTUP_FILE"
    chown "$GNOME_USER" "$STARTUP_FILE"
    chgrp users "$STARTUP_FILE"
fi

if test -n "$VERBOSE"; then
    echo =======================================
    echo $STARTUP_FILE
    echo =======================================
    cat $STARTUP_FILE
    echo =======================================
fi

exit 0

